name: Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    OPEN_API_GENERATOR_VERSION: 'v7.3.0'

jobs:
    generate-library-code:
        name: Generate Library Code ${{ matrix.language }}
        runs-on: ubuntu-latest
        strategy:
            matrix:
                language: ['go', 'typescript']
        steps:
            - name: Checkout
              # see https://github.com/actions/checkout
              uses: actions/checkout@v4
            - name: Run OpenAPI Generator
              uses: addnab/docker-run-action@v3
              with:
                  image: openapitools/openapi-generator-cli:${{ env.OPEN_API_GENERATOR_VERSION }}
                  options: -v ${{ github.workspace }}:/local
                  run: /usr/local/bin/docker-entrypoint.sh batch --clean /local/${{ matrix.language }}.yaml
            - name: Save to Cache
              uses: actions/cache/save@v4
              with:
                  path: out/${{ matrix.language }}
                  key: '${{ matrix.language }}-${{ github.sha }}'

    release-go:
        name: Release Go Library
        runs-on: ubuntu-latest
        needs: generate-library-code

        steps:
            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: 1.22
            - name: Checkout Go Library Repository
              uses: actions/checkout@v4
              with:
                  repository: sonatype-nexus-community/nexus-repo-api-client-go
                  ref: main
                  token: ${{ secrets.GO_LIB_GH_ACTION_TOKEN }}
            - name: Setup git config
              run: |
                  git config --global user.name "GitHub Actions"
                  git config --global user.email "<>"
            - name: Get generated code from cache
              uses: actions/cache/restore@v4
              with:
                  path: out/go
                  key: 'go-${{ github.sha }}'
                  fail-on-cache-miss: true
            - name: Validate Checked Out Library
              run: ls -lR ${{ github.workspace }}
            - name: Build Go API Client
              run: go build -v ./
              working-directory: ${{ github.workspace }}
            - name: Install test dependencies & run generated tests
              run: |
                  go get github.com/stretchr/testify/assert
                  go test -v ./test/
              working-directory: ${{ github.workspace }}
            - name: Commit, Tag and Push
              run: |
                  git add *
                  git commit -m "Automated Release ${{ github.ref_name }}"
                  #git tag -a ${{ github.ref_name }}" -m "Automated Release ${{ github.ref_name }}"
                  git push
